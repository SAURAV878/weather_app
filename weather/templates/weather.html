<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'light-bg': '#F0F4F8',
                        'light-card': '#FFFFFF',
                        'light-text': '#1E293B',
                        'dark-bg': '#0F172A',
                        'dark-card': '#1E293B',
                        'dark-text': '#E2E8F0',
                        'accent-blue': '#3B82F6',
                    },
                }
            }
        }
    </script>
    <style>
        @keyframes fade-slide-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse { 50% { opacity: .5; } }
        .animate-fade-slide-in { animation: fade-slide-in 0.5s ease-out forwards; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: rgba(156, 163, 175, 0.2); border-radius: 0.5rem; }
        .hourly-scroll::-webkit-scrollbar { display: none; }
        .hourly-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        body {
            overflow-y: hidden; /* Prevent scrolling on the body */
        }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text font-sans transition-colors duration-300">

    <div class="max-w-screen-xl mx-auto p-4 h-screen flex flex-col">
        <!-- HEADER -->
        <header class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <i class="fas fa-cloud-sun-rain text-xl text-accent-blue"></i>
                <h1 class="text-xl font-bold">Weather</h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="theme-toggle" class="text-lg px-2 py-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-4 flex-grow">

            <!-- LEFT COLUMN -->
            <aside class="lg:col-span-1 xl:col-span-1 flex flex-col gap-4">
                <div class="bg-light-card dark:bg-dark-card p-3 rounded-2xl shadow-md">
                    <div class="flex gap-2">
                        <input id="cityInput" type="text" placeholder="Search city..." class="w-full bg-light-bg dark:bg-dark-bg px-3 py-1 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-sm">
                        <button id="fetchWeatherBtn" class="bg-accent-blue text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition-colors text-sm"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="errorBox" class="hidden bg-red-100 text-red-700 p-2 rounded-lg mt-3 text-xs"></div>
                </div>

                <div class="bg-light-card dark:bg-dark-card p-3 rounded-2xl shadow-md flex-grow flex flex-col">
                    <h2 class="text-base font-semibold mb-2 flex items-center gap-2"><i class="fas fa-star text-yellow-400"></i> Saved</h2>
                    <ul id="saved-locations" class="space-y-1 overflow-y-auto text-sm max-h-24 hourly-scroll">
                        <li class="text-gray-500 dark:text-gray-400 p-1">No saved locations yet.</li>
                    </ul>
                </div>

                <!-- SINGLE DAY DETAILS (HIDDEN BY DEFAULT) - MOVED HERE -->
                <div id="single-day-details" class="bg-light-card dark:bg-dark-card p-4 rounded-2xl shadow-md hidden">
                    <h3 class="text-lg font-semibold mb-2" id="single-day-details-title">Details for --</h3>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <div class="flex justify-between"><span>Feels Like</span><span id="detail-single-feels-like" class="font-semibold">--°/--°</span></div>
                        <div class="flex justify-between"><span>Wind</span><span id="detail-single-wind" class="font-semibold">-- km/h</span></div>
                        <div class="flex justify-between"><span>UV Index</span><span id="detail-single-uv" class="font-semibold">--</span></div>
                        <div class="flex justify-between"><span>Precipitation</span><span id="detail-single-precipitation" class="font-semibold">--%</span></div>
                    </div>
                </div>
            </aside>

            <!-- MAIN CONTENT -->
            <div class="lg:col-span-2 xl:col-span-3 flex flex-col gap-4">
                <!-- SKELETON LOADER -->
                <div id="skeleton-loader" class="hidden space-y-4">
                    <div class="skeleton h-24 w-full"></div>
                    <div class="skeleton h-32 w-full"></div>
                    <div class="skeleton h-32 w-full"></div>
                </div>

                <!-- ACTUAL CONTENT -->
                <div id="weather-content" class="h-full flex flex-col gap-4 opacity-0">
                    <!-- CURRENT WEATHER -->
                    <div class="bg-light-card dark:bg-dark-card p-3 rounded-2xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-xl font-bold" id="cityName">--</h2>
                                <p class="text-gray-500 dark:text-gray-400 text-sm" id="countryName">--</p>
                                <p class="text-sm mt-1" id="currentDesc">--</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <i id="currentIcon" class="text-4xl text-yellow-400"></i>
                                <p class="text-5xl font-light"><span id="currentTemp">--</span>°</p>
                                <select id="unitSelect" class="bg-light-bg dark:bg-dark-bg rounded-lg p-1 self-start text-sm focus:outline-none focus:ring-2 focus:ring-accent-blue">
                                    <option value="celsius">C</option>
                                    <option value="fahrenheit">F</option>
                                </select>
                            </div>
                        </div>
                         <button id="save-location-btn" class="mt-2 text-xs text-accent-blue hover:underline"><i class="far fa-star"></i> Save Location</button>
                    </div>
                    
                    <!-- HOURLY & CHART GRID -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-grow">
                        <div class="md:col-span-2 bg-light-card dark:bg-dark-card p-3 rounded-2xl shadow-md flex flex-col">
                            <h3 class="text-base font-semibold mb-2" id="hourly-forecast-title">Hourly Forecast</h3>
                            <div id="hourly-forecast" class="flex overflow-x-auto gap-2 hourly-scroll"></div>
                        </div>
                        <div class="bg-light-card dark:bg-dark-card p-3 rounded-2xl shadow-md flex flex-col">
                            <h3 class="text-base font-semibold mb-2" id="chart-title">Temperature Trend</h3>
                            <div class="relative flex-grow">
                                <canvas id="tempChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 7-DAY FORECAST -->
                    <div class="bg-light-card dark:bg-dark-card p-3 rounded-2xl shadow-md flex flex-col">
                        <h3 class="text-base font-semibold mb-2">7-Day Forecast</h3>
                        <div id="forecast-list" class="space-y-1 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Elements ---
    const cityInput = document.getElementById("cityInput");
    const fetchWeatherBtn = document.getElementById("fetchWeatherBtn");
    const unitSelect = document.getElementById("unitSelect");
    const errorBox = document.getElementById("errorBox");
    const themeToggle = document.getElementById('theme-toggle');
    const hourlyForecastDiv = document.getElementById('hourly-forecast');
    const forecastListDiv = document.getElementById('forecast-list');
    const saveLocationBtn = document.getElementById('save-location-btn');
    const savedLocationsList = document.getElementById('saved-locations');
    const skeletonLoader = document.getElementById('skeleton-loader');
    const weatherContent = document.getElementById('weather-content');
    const tempChartCanvas = document.getElementById('tempChart');
    const singleDayDetailsCard = document.getElementById('single-day-details');
    const singleDayDetailsTitle = document.getElementById('single-day-details-title');
    const detailSingleFeelsLike = document.getElementById('detail-single-feels-like');
    const detailSingleWind = document.getElementById('detail-single-wind');
    const detailSingleUv = document.getElementById('detail-single-uv');
    const detailSinglePrecipitation = document.getElementById('detail-single-precipitation');
    const hourlyForecastTitle = document.getElementById('hourly-forecast-title');
    const chartTitle = document.getElementById('chart-title');


    // --- State & Config ---
    let currentCity = null;
    let tempChart = null;
    let fullHourlyData = []; // Store full 7-day hourly forecast
    let savedLocations = JSON.parse(localStorage.getItem('savedLocations')) || [];
    const icons = {
        "Clear": "fa-sun", "Clouds": "fa-cloud", "Rain": "fa-cloud-showers-heavy",
        "Drizzle": "fa-cloud-rain", "Thunderstorm": "fa-bolt", "Snow": "fa-snowflake",
        "Fog": "fa-smog",
    };
    const defaultIcon = "fa-question-circle";
    
    // --- Initializer ---
    const init = () => {
        setupTheme();
        renderSavedLocations();
        const lastSearch = localStorage.getItem('lastWeatherSearch');
        if (lastSearch && lastSearch.trim() !== '') {
            fetchWeather(lastSearch);
        }
        
        themeToggle.addEventListener('click', toggleTheme);
        fetchWeatherBtn.addEventListener("click", () => fetchWeather(cityInput.value.trim()));
        cityInput.addEventListener("keypress", e => e.key === "Enter" && fetchWeather(cityInput.value.trim()));
        saveLocationBtn.addEventListener('click', handleSaveLocation);
        unitSelect.addEventListener('change', () => {
            if(currentCity) fetchWeather(currentCity);
        });
    };

    // --- Theme Management ---
    const setupTheme = () => {
        const userPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');
        if ((savedTheme === 'dark') || (!savedTheme && userPrefersDark)) {
            document.documentElement.classList.add('dark');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            document.documentElement.classList.remove('dark');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
    };
    const toggleTheme = () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    };

    // --- UI & Rendering ---
    const showLoader = (show) => {
        skeletonLoader.classList.toggle('hidden', !show);
        weatherContent.classList.toggle('opacity-0', show);
        if (!show) {
            weatherContent.classList.add('animate-fade-slide-in');
        }
    };

    const showError = (msg) => {
        errorBox.classList.toggle("hidden", !msg);
        if (msg) errorBox.textContent = msg;
    };

    const renderSavedLocations = () => {
        savedLocationsList.innerHTML = "";
        if (savedLocations.length === 0) {
            savedLocationsList.innerHTML = `<li class="text-gray-500 dark:text-gray-400 p-1">No saved locations yet.</li>`;
            return;
        }
        savedLocations.forEach(location => {
            const li = document.createElement('li');
            li.className = "flex justify-between items-center p-1 rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg cursor-pointer";
            li.innerHTML = `<span>${location}</span><button data-location="${location}" class="delete-location-btn text-red-500 hover:text-red-700 text-xs"><i class="fas fa-trash"></i></button>`;
            li.addEventListener('click', (e) => {
                if (!e.target.closest('.delete-location-btn')) {
                    fetchWeather(location);
                }
            });
            savedLocationsList.appendChild(li);
        });
        document.querySelectorAll('.delete-location-btn').forEach(btn => btn.addEventListener('click', handleDeleteLocation));
    };
    
    // --- API & Data Handling ---
    async function fetchWeather(city) {
        if (!city) {
            showError("Please enter a city name.");
            return;
        }
        showLoader(true);
        showError(null);

        try {
            const unit = unitSelect.value;
            const response = await fetch(`/current_weather/?city=${city}&unit=${unit}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Failed to fetch weather data.");
            }
            const data = await response.json();
            currentCity = data.city; // Update currentCity immediately
            displayWeather(data);
            localStorage.setItem('lastWeatherSearch', city);
            // currentCity = data.city; // This line is moved up
        } catch (error) {
            showError(error.message);
        } finally {
            showLoader(false);
        }
    }
    
    // --- Location Management ---
    const handleSaveLocation = () => {
        if (!currentCity || savedLocations.includes(currentCity)) return;
        savedLocations.push(currentCity);
        localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
        renderSavedLocations();
        updateSaveButton();
    };
    const handleDeleteLocation = (e) => {
        const locationToDelete = e.currentTarget.dataset.location;
        savedLocations = savedLocations.filter(loc => loc !== locationToDelete);
        localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
        renderSavedLocations();
        updateSaveButton();
    };

    const updateSaveButton = () => {
        if(savedLocations.includes(currentCity)) {
            saveLocationBtn.innerHTML = '<i class="fas fa-star"></i> Saved';
            saveLocationBtn.disabled = true;
        } else {
            saveLocationBtn.innerHTML = '<i class="far fa-star"></i> Save Location';
            saveLocationBtn.disabled = false;
        }
    }

    // --- Display Functions ---
    const displayWeather = (data) => {
        document.getElementById("cityName").textContent = data.city;
        document.getElementById("countryName").textContent = data.country;
        document.getElementById("currentTemp").textContent = data.current.temp;
        document.getElementById("currentDesc").textContent = data.current.description;
        document.getElementById("currentIcon").className = `text-4xl text-yellow-400 fas ${mapDescriptionToIcon(data.current.main)}`;

        fullHourlyData = data.hourly; // Store full hourly data

        // Display current hourly forecast (first 24 hours)
        updateHourlyForecastDisplay(fullHourlyData.slice(0, 24));
        renderTemperatureChart(fullHourlyData.slice(0, 24));
        hourlyForecastTitle.textContent = "Hourly Forecast (Today)";
        chartTitle.textContent = "Temperature Trend (Today)";

        forecastListDiv.innerHTML = "";
        singleDayDetailsCard.classList.add('hidden'); // Hide details when new city loads

        data.daily.forEach(day => {
            const item = document.createElement("div");
            item.className = "border-b border-gray-200 dark:border-gray-700 last:border-b-0 py-1";
            const date = new Date(day.day);
            const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'short' });
            const dayDate = day.day; // YYYY-MM-DD

            item.innerHTML = `
                <div class="grid grid-cols-4 items-center gap-2 cursor-pointer hover:bg-light-bg dark:hover:bg-dark-bg rounded-lg p-2 daily-summary">
                    <p class="font-medium text-sm col-span-1">${dayOfWeek}</p>
                    <div class="col-span-1 flex items-center gap-2">
                        <i class="fas ${mapDescriptionToIcon(day.main)}"></i>
                        <span class="text-xs hidden sm:inline">${day.description}</span>
                    </div>
                    <div class="col-span-2 text-right text-sm">
                        <span class="font-semibold">${day.max_temp}°</span> / 
                        <span class="text-gray-500 dark:text-gray-400">${day.min_temp}°</span>
                    </div>
                </div>`;
            
            const summary = item.querySelector('.daily-summary');
            summary.addEventListener('click', () => {
                updateSingleDayDetails(day, dayOfWeek);
                // Update hourly forecast and chart for the clicked day
                const selectedDayHourlyData = fullHourlyData.filter(hour => hour.time.startsWith(dayDate));
                updateHourlyForecastDisplay(selectedDayHourlyData);
                renderTemperatureChart(selectedDayHourlyData);
                hourlyForecastTitle.textContent = `Hourly Forecast (${dayOfWeek})`;
                chartTitle.textContent = `Temperature Trend (${dayOfWeek})`;
            });
            forecastListDiv.appendChild(item);
        });

        updateSaveButton();
    };

    const updateHourlyForecastDisplay = (hourlyData) => {
        hourlyForecastDiv.innerHTML = "";
        hourlyData.forEach(hour => {
            const card = document.createElement("div");
            card.className = "flex-shrink-0 text-center space-y-1 p-2";
            card.innerHTML = `
                <p class="text-sm text-gray-500 dark:text-gray-400">${hour.time.substring(11, 16)}</p> <!-- HH:MM -->
                <i class="fas ${mapDescriptionToIcon(hour.main)} text-base"></i>
                <p class="font-semibold text-sm">${hour.temp}°</p>`;
            hourlyForecastDiv.appendChild(card);
        });
    };

    const updateSingleDayDetails = (dayData, dayOfWeek) => {
        singleDayDetailsTitle.textContent = `Details for ${dayOfWeek}`;
        detailSingleFeelsLike.textContent = `${dayData.apparent_max}°/${dayData.apparent_min}°`;
        detailSingleWind.textContent = `${dayData.wind_speed} km/h`;
        detailSingleUv.textContent = dayData.uv_index;
        detailSinglePrecipitation.textContent = `${dayData.precipitation_probability}%`;
        singleDayDetailsCard.classList.remove('hidden'); // Show the details card
    };

    const renderTemperatureChart = (hourlyData) => {
        if (tempChart) {
            tempChart.destroy();
        }
        const ctx = tempChartCanvas.getContext('2d');
        const isDark = document.documentElement.classList.contains('dark');
        
        tempChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: hourlyData.map(h => h.time.substring(11, 16)), // HH:MM
                datasets: [{
                    label: 'Temp',
                    data: hourlyData.map(h => h.temp),
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3, // Show points
                    pointBackgroundColor: '#3B82F6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        display: true, // Show Y-axis
                        beginAtZero: false,
                        grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' },
                        ticks: { color: isDark ? '#E2E8F0' : '#1E293B' },
                        title: { display: true, text: 'Temperature (°)', color: isDark ? '#E2E8F0' : '#1E293B' }
                    },
                    x: {
                        display: true, // Show X-axis
                        grid: { display: false },
                        ticks: { color: isDark ? '#E2E8F0' : '#1E293B' },
                        title: { display: true, text: 'Time', color: isDark ? '#E2E8F0' : '#1E293B' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return ` ${context.dataset.label}: ${context.raw}°`;
                            }
                        }
                    }
                },
                layout: {
                    padding: { top: 5, bottom: 5 }
                }
            }
        });
    };

    // --- Helpers ---
    const mapDescriptionToIcon = (desc) => {
        if (desc.includes("Clear")) return icons["Clear"];
        if (desc.includes("Cloudy") || desc.includes("Overcast")) return icons["Clouds"];
        if (desc.includes("Rain") || desc.includes("Drizzle")) return icons["Rain"];
        if (desc.includes("Thunderstorm")) return icons["Thunderstorm"];
        if (desc.includes("Snow")) return icons["Snow"];
        if (desc.includes("Fog")) return icons["Fog"];
        return defaultIcon;
    };
    
    init();
});
</script>
</body>
</html>
